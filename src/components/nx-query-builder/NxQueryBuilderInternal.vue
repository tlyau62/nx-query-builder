<template>
  <div class="nx-query-builder-internal">
    <div class="nx-query-builder-internal__querybuilder" />
    <div style="display: none">
      <slot></slot>
    </div>
  </div>
</template>

<script>
import $ from "jquery";
import "jQuery-QueryBuilder/dist/js/query-builder.js";
import { isNil, cloneDeep } from "lodash";
import NxQueryFilterInput from "./NxQueryFilterInput";
import Vue from "vue";

export default {
  name: "NxQueryBuilderInternal",
  props: {
    filters: {
      type: Array,
    },
    value: {
      type: Object,
    },
  },
  data() {
    return {
      init: false,
      tempValue: null,
      comps: {},
    };
  },
  computed: {
    builder() {
      return $(this.$el);
    },
  },
  beforeMount() {
    this.componentStore = [];
    this.config.filters = [];

    this.$on("filter-created", (filter) => {
      if (this.init) {
        this.$emit("refresh");
      } else {
        this.config.filters.push(filter);
      }
    });
  },
  created() {
    this.config = {};
  },
  mounted() {
    const { builder } = this;

    if (this.config.filters.length === 0) {
      return;
    }

    const comps = this.comps;

    const filters = this.config.filters.map((filter) => {
      if (!filter.context.$scopedSlots.default) {
        return filter;
      }

      return {
        ...filter,
        input(rule, name) {
          if (name.endsWith(rule.id)) {
            name += "_value_0";
          }

          const valNum = parseInt(name.split("value_")[1]);

          if (!comps[rule.id]) {
            comps[rule.id] = [];
          }

          const comp = comps[rule.id][valNum];

          if (comp) {
            comp.$destroy();
          }

          const InputClass = Vue.extend(NxQueryFilterInput);
          comps[rule.id][valNum] = new InputClass({
            propsData: {
              context: filter.context,
              rule,
            },
          });

          return $(comps[rule.id][valNum].$mount().$el);
        },
        valueGetter(rule) {
          if (rule.operator.nb_inputs === 1) {
            return comps[rule.id][0].scope.value;
          }

          return comps[rule.id].map((comp) => comp.scope.value);
        },
        valueSetter(rule, value) {
          if (rule.operator.nb_inputs === 1) {
            comps[rule.id][0].scope.value = value;
          }

          for (const comp of comps[rule.id]) {
            comp.scope.value = value;
          }
        },
      };
    });

    builder.queryBuilder({
      filters,
      rules: this.value,
    });

    builder.queryBuilder("validate");

    this.registerRulesChanged();

    this.emitRules();

    this.init = true;
  },
  watch: {
    filters(filters) {
      this.$emit("refresh");
    },
    value(value) {
      if (!isNil(value) && value !== this.tempValue) {
        this.setRules(value);
      }
    },
  },
  beforeDestroy() {
    const { builder, comps } = this;

    if (builder) {
      for (const comp of Object.values(comps).flat()) {
        comp.$destroy();
      }
      builder.off("rulesChanged.queryBuilder"); // similar issue to https://github.com/mistic100/jQuery-QueryBuilder/issues/833
      builder.queryBuilder("destroy");
    }
  },
  methods: {
    emitRules() {
      const rules = this.builder.queryBuilder("getRules", {
        allow_invalid: true,
      });

      this.tempValue = rules;

      this.$emit("input", rules);
    },
    setFilters(filters) {
      this.builder.queryBuilder("reset");
      this.builder.queryBuilder("setFilters", filters);
    },

    /**
     * https://github.com/mistic100/jQuery-QueryBuilder/issues/833
     */
    setRules(rules) {
      this.registerRulesChanged(() => {
        this.builder.queryBuilder("setRules", cloneDeep(rules));
      });
    },

    registerRulesChanged(fn = () => {}) {
      this.builder.off("rulesChanged.queryBuilder");
      fn();
      this.builder.on("rulesChanged.queryBuilder", (e, level) =>
        this.emitRules()
      );
    },
  },
};
</script>

<style lang="scss">
@import "~jQuery-QueryBuilder/dist/css/query-builder.default.min.css";
</style>
